input {
  tcp {
    port => 5000
    codec => json
  }
  
  udp {
    port => 5000
    codec => json
  }
}

filter {
  # Parsear logs JSON del microservicio
  if [message] =~ /^{.*}$/ {
    json {
      source => "message"
    }
  }
  
  # Agregar campos adicionales
  mutate {
    add_field => {
      "[@metadata][service]" => "transaction-validator"
      "[@metadata][environment]" => "production"
    }
  }
  
  # Parsear timestamp
  date {
    match => [ "timestamp", "ISO8601" ]
    target => "@timestamp"
  }
  
  # Extraer nivel de severidad
  if [levelname] {
    mutate {
      rename => { "levelname" => "level" }
      lowercase => [ "level" ]
    }
  }
  
  # Clasificar por severidad
  if [level] == "error" or [level] == "critical" {
    mutate {
      add_tag => [ "error" ]
    }
  }
  
  if [level] == "warning" {
    mutate {
      add_tag => [ "warning" ]
    }
  }
  
  # Agregar informaciÃ³n de trazas
  if [otelTraceID] {
    mutate {
      rename => {
        "otelTraceID" => "trace_id"
        "otelSpanID" => "span_id"
      }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "logstash-transaction-validator-%{+YYYY.MM.dd}"
    document_type => "_doc"
  }
  
  # Output a stdout para debugging (opcional)
  stdout {
    codec => rubydebug
  }
}
